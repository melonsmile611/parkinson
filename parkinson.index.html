<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PD Helper - Medication & Symptom Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-press {
            transition: all 0.1s;
        }
        .btn-press:active {
            transform: scale(0.98);
        }
        
        .pulse-ring {
            animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        
        .slide-up {
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .site-btn {
            transition: all 0.2s;
        }
        
        .site-btn.active {
            background-color: #dbeafe;
            border-color: #3b82f6;
            transform: scale(1.05);
        }
        
        .symptom-btn {
            transition: all 0.2s;
        }
        
        .symptom-btn.selected {
            background-color: #fed7aa;
            border-color: #f97316;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }
        
        .dyskinesia-btn.selected {
            background-color: #c4b5fd;
            border-color: #8b5cf6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .bolus-btn {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        
        * {
            touch-action: manipulation;
        }
        
        .emergency-btn {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            box-shadow: 0 10px 25px -5px rgba(220, 38, 38, 0.4);
        }
    </style>
</head>
<body class="bg-gray-50 h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-sm px-4 py-3 flex justify-between items-center border-b-4 border-blue-100">
        <div>
            <h1 class="text-xl font-bold text-gray-800">PD Helper</h1>
            <p class="text-xs text-gray-500 mt-0.5" id="currentDate">Loading...</p>
        </div>
        <div class="flex gap-2">
            <button onclick="switchMode('oral')" id="btn-oral" class="px-3 py-1.5 rounded-full text-xs font-bold bg-blue-600 text-white shadow-md transition-all">
                Madopar
            </button>
            <button onclick="switchMode('pump')" id="btn-pump" class="px-3 py-1.5 rounded-full text-xs font-bold bg-gray-200 text-gray-600 shadow-sm transition-all">
                Apomorphine
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto p-3 space-y-3" id="mainContent">
        
        <!-- Oral Madopar Mode -->
        <div id="oralMode" class="space-y-3">
            <!-- Today's Schedule -->
            <div class="bg-white rounded-2xl p-4 shadow-md border-2 border-gray-100">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-bold text-gray-800">Today's Schedule</h2>
                    <button onclick="editTodaySchedule()" class="text-blue-600 text-sm font-bold px-3 py-1 bg-blue-50 rounded-full">
                        Edit Times
                    </button>
                </div>
                
                <div id="doseList" class="space-y-2">
                    <!-- Dynamic dose cards -->
                </div>
                
                <button onclick="addNewDose()" class="w-full mt-3 border-2 border-dashed border-gray-300 rounded-xl p-3 text-gray-500 font-medium text-sm btn-press hover:bg-gray-50">
                    + Add Extra Dose
                </button>
            </div>

            <!-- Next Dose Reminder -->
            <div id="nextDoseReminder" class="bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl p-4 shadow-lg border-4 border-red-200 hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center pulse-ring">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-xl font-black text-gray-800">Time for Medicine!</h3>
                            <p class="text-red-600 font-bold text-lg" id="nextDoseTimeDisplay">--:--</p>
                        </div>
                    </div>
                    <button onclick="takeMedicineNow()" class="bg-green-500 hover:bg-green-600 text-white font-bold text-lg px-6 py-3 rounded-xl shadow-lg btn-press border-b-4 border-green-700 active:border-b-0">
                        Take
                    </button>
                </div>
            </div>

            <!-- Quick OFF Episode Record -->
            <div class="bg-white rounded-2xl p-4 shadow-md border-l-4 border-purple-500">
                <h3 class="text-base font-bold text-gray-800 mb-3">Quick Record "OFF" Episode</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="recordOffEpisode('sudden')" class="bg-purple-100 border-2 border-purple-300 rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-purple-900">Sudden Freeze</div>
                    </button>
                    <button onclick="recordOffEpisode('wearing')" class="bg-orange-100 border-2 border-orange-300 rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-orange-900">Wearing Off</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Apomorphine Pump Mode -->
        <div id="pumpMode" class="space-y-3 hidden">
            <!-- Pump Status -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-4 shadow-md border-2 border-blue-200">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
                        <h2 class="text-lg font-bold text-gray-800">Pump Running</h2>
                    </div>
                    <button onclick="editPumpSettings()" class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded-full font-medium">Settings</button>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div class="bg-white rounded-xl p-3 shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">Base Rate</div>
                        <div class="text-xl font-bold text-blue-600" id="pumpBaseRate">-- <span class="text-sm">mg/h</span></div>
                    </div>
                    <div class="bg-white rounded-xl p-3 shadow-sm">
                        <div class="text-xs text-gray-500 mb-1">Today Total</div>
                        <div class="text-xl font-bold text-gray-800" id="pumpTotalToday">0 <span class="text-sm">mg</span></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-3 shadow-inner">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm text-gray-600">Drug Left</span>
                        <span class="text-lg font-bold text-blue-600" id="drugLeftPercent">--%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                        <div class="bg-blue-500 h-full rounded-full transition-all" id="drugLeftBar" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-orange-600 font-medium mt-2" id="refillNotice">Set up your pump info</p>
                </div>
            </div>

            <!-- Bolus Record -->
            <div class="bg-white rounded-2xl p-4 shadow-md border-2 border-orange-200">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span class="text-orange-500"></span> Bolus (Rescue Dose)
                    </h3>
                    <span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded-full" id="bolusCountToday">Today: 0</span>
                </div>
                
                <div class="bg-orange-50 rounded-xl p-3 mb-3 border border-orange-200">
                    <p class="text-sm text-gray-700 leading-relaxed">
                        Press the Bolus button on pump when "OFF" symptoms appear
                    </p>
                </div>

                <button onclick="recordBolus()" class="w-full bolus-btn text-white font-black text-xl py-4 rounded-xl shadow-lg btn-press border-b-4 border-orange-800 active:border-b-0 active:mt-1 flex items-center justify-center gap-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Record Bolus
                </button>

                <div id="bolusList" class="mt-3 space-y-2">
                    <!-- Bolus records loaded from storage -->
                </div>
            </div>

            <!-- Daily Site Check -->
            <div class="bg-gradient-to-r from-yellow-50 to-amber-50 rounded-2xl p-4 shadow-md border-2 border-yellow-300">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span class="text-2xl"></span> Daily Site Check
                    </h3>
                    <span id="siteCheckStatus" class="text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full font-bold">Pending</span>
                </div>
                
                <button onclick="doDailySiteCheck()" id="siteCheckBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold text-lg py-3 rounded-xl shadow-md btn-press border-b-4 border-yellow-700 active:border-b-0 flex items-center justify-center gap-2 mb-3">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Start Today's Check
                </button>

                <div id="currentSiteDisplay" class="text-center text-sm text-gray-600 bg-white rounded-lg p-2 hidden">
                    Current Site: <span class="font-bold text-blue-600" id="currentSiteText">-</span>
                </div>
            </div>
        </div>

        <!-- Today's Records -->
        <div class="bg-white rounded-2xl p-4 shadow-md">
            <h3 class="text-base font-bold text-gray-800 mb-3">Today's Records</h3>
            <div class="space-y-2 max-h-40 overflow-y-auto" id="todayRecords">
                <!-- Records loaded from storage -->
            </div>
        </div>

        <!-- Data Management -->
        <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
            <h4 class="text-sm font-bold text-blue-800 mb-2">Data Management</h4>
            <p class="text-xs text-blue-600 mb-3">Data is saved on this device. Use Export to backup or transfer to another device.</p>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="exportData()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded-lg text-sm btn-press flex items-center justify-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export
                </button>
                <button onclick="importData()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 rounded-lg text-sm btn-press flex items-center justify-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    Import
                </button>
            </div>
            <button onclick="clearAllData()" class="w-full mt-2 bg-red-100 text-red-700 font-bold py-2 rounded-lg text-sm btn-press">
                Clear All Data
            </button>
        </div>

        <!-- Emergency -->
        <div class="sticky bottom-2 mt-4 mb-2">
            <button onclick="emergencyCall()" class="w-full emergency-btn text-white font-black text-lg py-4 rounded-xl btn-press flex items-center justify-center gap-2 shadow-lg">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                </svg>
                Emergency Call
            </button>
        </div>
    </main>

    <!-- Edit Schedule Modal -->
    <div id="editScheduleModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-4 slide-up max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-black text-gray-800">Edit Today's Schedule</h2>
                <button onclick="closeModal('editScheduleModal')" class="text-gray-500 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="bg-blue-50 rounded-xl p-3 mb-4 text-sm text-blue-800">
                 Tip: If "ON" delayed this morning, adjust all times later
            </div>

            <div id="scheduleEditor" class="space-y-3 mb-4">
                <!-- Dynamic schedule editor -->
            </div>

            <button onclick="addTimeSlot()" class="w-full border-2 border-dashed border-blue-300 rounded-xl p-3 text-blue-600 font-medium mb-4 btn-press">
                + Add Dose Time
            </button>

            <div class="flex gap-3">
                <button onclick="closeModal('editScheduleModal')" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-xl btn-press">
                    Cancel
                </button>
                <button onclick="saveSchedule()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl btn-press shadow-lg">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- Symptom Record Modal (After Taking Medicine) -->
    <div id="symptomModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-4 slide-up max-h-[90vh] overflow-y-auto">
            <div class="text-center mb-4">
                <div class="w-16 h-1 bg-gray-300 rounded-full mx-auto mb-3"></div>
                <h2 class="text-2xl font-black text-gray-800">Record Symptoms</h2>
                <p class="text-gray-600 text-sm mt-1" id="symptomDoseInfo">After --:-- Madopar</p>
            </div>

            <!-- Motor Symptoms -->
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Motor Symptoms</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="toggleSymptom(this, 'tremor')" class="symptom-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-gray-800">Tremor</div>
                    </button>
                    <button onclick="toggleSymptom(this, 'stiff')" class="symptom-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-gray-800">Stiffness</div>
                    </button>
                    <button onclick="toggleSymptom(this, 'slow')" class="symptom-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-gray-800">Slowness</div>
                    </button>
                    <button onclick="toggleSymptom(this, 'balance')" class="symptom-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-gray-800">Balance</div>
                    </button>
                </div>
            </div>

            <!-- Dyskinesia -->
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Dyskinesia (Involuntary Movements)</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="toggleSymptom(this, 'dyskinesia_mild')" class="dyskinesia-btn symptom-btn bg-purple-100 border-2 border-gray-300 rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-purple-800">Mild</div>
                        <div class="text-xs text-purple-600">Slight twisting</div>
                    </button>
                    <button onclick="toggleSymptom(this, 'dyskinesia_severe')" class="dyskinesia-btn symptom-btn bg-purple-200 border-2 border-gray-300 rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-purple-900">Severe</div>
                        <div class="text-xs text-purple-700">Can't sit still</div>
                    </button>
                </div>
            </div>

            <!-- Non-Motor Symptoms -->
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Non-Motor Symptoms</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="toggleSymptom(this, 'pain')" class="symptom-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-2 text-center btn-press">
                        <div class="text-xl mb-1"></div>
                        <div class="text-xs font-bold text-gray-800">Pain</div>
                    </button>
                    <button onclick="toggleSymptom(this, 'sleepy')" class="symptom-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-2 text-center btn-press">
                        <div class="text-xl mb-1"></div>
                        <div class="text-xs font-bold text-gray-800">Sleepy</div>
                    </button>
                    <button onclick="toggleSymptom(this, 'nausea')" class="symptom-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-2 text-center btn-press">
                        <div class="text-xl mb-1"></div>
                        <div class="text-xs font-bold text-gray-800">Nausea</div>
                    </button>
                </div>
            </div>

            <!-- ON/OFF Status -->
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Medication Response <span class="text-red-500">*</span></label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectResponse(this, 'good')" class="response-btn bg-green-100 border-2 border-transparent rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-green-800">Good ON</div>
                    </button>
                    <button onclick="selectResponse(this, 'partial')" class="response-btn bg-yellow-100 border-2 border-transparent rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-yellow-800">Partial</div>
                    </button>
                    <button onclick="selectResponse(this, 'poor')" class="response-btn bg-red-100 border-2 border-transparent rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-red-800">Still OFF</div>
                    </button>
                </div>
            </div>

            <button onclick="submitSymptomsAfterDose()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-black text-xl py-4 rounded-xl shadow-lg btn-press border-b-4 border-purple-800 active:border-b-0">
                Save Record 
            </button>
            
            <button onclick="closeModal('symptomModal')" class="w-full mt-2 bg-gray-200 text-gray-600 font-bold text-lg py-3 rounded-xl btn-press">
                Skip
            </button>
        </div>
    </div>

    <!-- Bolus Modal -->
    <div id="bolusModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-4 slide-up">
            <div class="text-center mb-4">
                <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-3"></div>
                <h2 class="text-xl font-black text-gray-800">Record Bolus</h2>
                <p class="text-gray-600 text-sm mt-1">Extra dose 3-5mg</p>
            </div>

            <div class="space-y-3 mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Why needed Bolus?</label>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="selectBolusReason(this, 'sudden')" class="bolus-reason-btn bg-purple-100 border-2 border-transparent rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-purple-900">Sudden OFF</div>
                    </button>
                    <button onclick="selectBolusReason(this, 'wearing')" class="bolus-reason-btn bg-orange-100 border-2 border-transparent rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-orange-900">Wearing Off</div>
                    </button>
                    <button onclick="selectBolusReason(this, 'morning')" class="bolus-reason-btn bg-blue-100 border-2 border-transparent rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-blue-900">Morning Stiff</div>
                    </button>
                    <button onclick="selectBolusReason(this, 'stress')" class="bolus-reason-btn bg-red-100 border-2 border-transparent rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-red-900">Stress</div>
                    </button>
                </div>
            </div>

            <div class="bg-gray-50 rounded-xl p-3 mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Notes (optional)</label>
                <input type="text" id="bolusNote" placeholder="e.g. before meal, after exercise..." class="w-full p-3 rounded-lg border-2 border-gray-200 text-base focus:border-blue-500 focus:outline-none">
            </div>

            <button onclick="submitBolus()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-black text-xl py-4 rounded-xl shadow-lg btn-press border-b-4 border-orange-700 active:border-b-0">
                Confirm
            </button>
            
            <button onclick="closeModal('bolusModal')" class="w-full mt-2 bg-gray-200 text-gray-600 font-bold py-3 rounded-xl btn-press">
                Cancel
            </button>
        </div>
    </div>

    <!-- Site Check Modal -->
    <div id="siteCheckModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-4 slide-up">
            <h2 class="text-xl font-black text-gray-800 mb-4 text-center">Daily Infusion Site Check</h2>
            
            <div class="bg-yellow-50 rounded-xl p-4 mb-4 border-2 border-yellow-200">
                <h4 class="font-bold text-sm text-yellow-800 mb-2">Checklist:</h4>
                <ul class="text-sm text-gray-700 space-y-1">
                    <li> Redness or swelling?</li>
                    <li> Pain or nodules?</li>
                    <li> Needle secure?</li>
                    <li> Flow smooth?</li>
                </ul>
            </div>

            <!-- Site Selection -->
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Select Today's Site</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="selectSite(this, 'left_abdomen')" class="site-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-4 text-center btn-press">
                        <div class="text-3xl mb-2"></div>
                        <div class="text-base font-bold text-gray-800">Left Abdomen</div>
                    </button>
                    <button onclick="selectSite(this, 'right_abdomen')" class="site-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-4 text-center btn-press">
                        <div class="text-3xl mb-2"></div>
                        <div class="text-base font-bold text-gray-800">Right Abdomen</div>
                    </button>
                    <button onclick="selectSite(this, 'left_leg')" class="site-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-4 text-center btn-press">
                        <div class="text-3xl mb-2"></div>
                        <div class="text-base font-bold text-gray-800">Left Leg</div>
                    </button>
                    <button onclick="selectSite(this, 'right_leg')" class="site-btn bg-gray-100 border-2 border-gray-300 rounded-xl p-4 text-center btn-press">
                        <div class="text-3xl mb-2"></div>
                        <div class="text-base font-bold text-gray-800">Right Leg</div>
                    </button>
                </div>
            </div>

            <!-- Skin Status -->
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">Skin Condition</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectSkinStatus(this, 'good')" class="skin-btn bg-green-100 border-2 border-transparent rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-green-800">Good</div>
                    </button>
                    <button onclick="selectSkinStatus(this, 'red')" class="skin-btn bg-red-100 border-2 border-transparent rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-red-800">Red</div>
                    </button>
                    <button onclick="selectSkinStatus(this, 'nodule')" class="skin-btn bg-orange-100 border-2 border-transparent rounded-xl p-3 text-center btn-press">
                        <div class="text-2xl mb-1"></div>
                        <div class="text-sm font-bold text-orange-800">Nodule</div>
                    </button>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeModal('siteCheckModal')" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-xl btn-press">
                    Cancel
                </button>
                <button onclick="submitSiteCheck()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-xl btn-press shadow-lg">
                    Complete
                </button>
            </div>
        </div>
    </div>

    <!-- Pump Settings Modal -->
    <div id="pumpSettingsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full max-w-md rounded-t-2xl sm:rounded-2xl p-4 slide-up">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-xl font-black text-gray-800">Pump Settings</h2>
                <button onclick="closeModal('pumpSettingsModal')" class="text-gray-500 p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <div class="space-y-4 mb-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Base Rate (mg/hour)</label>
                    <input type="number" id="settingBaseRate" step="0.1" value="3.5" class="w-full p-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Drug Cartridge Total (mg)</label>
                    <input type="number" id="settingCartridgeTotal" value="100" class="w-full p-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Current Drug Left (mg)</label>
                    <input type="number" id="settingDrugLeft" value="65" class="w-full p-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none">
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeModal('pumpSettingsModal')" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-xl btn-press">
                    Cancel
                </button>
                <button onclick="savePumpSettings()" class="flex-1 bg-blue-600 text-white font-bold py-3 rounded-xl btn-press shadow-lg">
                    Save Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Success Toast -->
    <div id="successToast" class="fixed top-4 left-4 right-4 bg-green-500 text-white p-4 rounded-xl shadow-2xl transform -translate-y-full transition-transform duration-300 z-50 text-center">
        <div class="text-2xl mb-1"></div>
        <div class="text-lg font-bold" id="toastTitle">Saved</div>
        <div class="text-sm" id="toastMessage"></div>
    </div>

    <!-- Hidden download link -->
    <a id="downloadLink" style="display:none"></a>

    <script>
        // Storage keys
        const STORAGE_KEYS = {
            SCHEDULE: 'pd_schedule',
            RECORDS: 'pd_records',
            PUMP_DATA: 'pd_pump_data',
            SITE_CHECK: 'pd_site_check',
            LAST_DATE: 'pd_last_date'
        };

        // State
        let currentMode = 'oral';
        let todaySchedule = [];
        let currentBolusReason = null;
        let selectedSite = null;
        let selectedSkinStatus = null;
        let siteCheckedToday = false;
        let currentSymptoms = new Set();
        let currentResponse = null;
        let lastDoseInfo = null;

        const siteNames = {
            'left_abdomen': 'Left Abdomen',
            'right_abdomen': 'Right Abdomen',
            'left_leg': 'Left Leg',
            'right_leg': 'Right Leg'
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkNewDay();
            loadAllData();
            updateDate();
            renderDoseList();
            checkNextDose();
            renderAllRecords();
            updatePumpDisplay();
        });

        function checkNewDay() {
            const lastDate = localStorage.getItem(STORAGE_KEYS.LAST_DATE);
            const today = new Date().toDateString();
            
            if (lastDate !== today) {
                localStorage.setItem(STORAGE_KEYS.LAST_DATE, today);
                
                const siteCheckData = JSON.parse(localStorage.getItem(STORAGE_KEYS.SITE_CHECK) || '{}');
                siteCheckData.checked = false;
                localStorage.setItem(STORAGE_KEYS.SITE_CHECK, JSON.stringify(siteCheckData));
                
                const pumpData = JSON.parse(localStorage.getItem(STORAGE_KEYS.PUMP_DATA) || '{}');
                pumpData.todayTotal = 0;
                pumpData.bolusCount = 0;
                pumpData.bolusRecords = [];
                pumpData.hoursRunning = 0;
                localStorage.setItem(STORAGE_KEYS.PUMP_DATA, JSON.stringify(pumpData));
                
                const schedule = JSON.parse(localStorage.getItem(STORAGE_KEYS.SCHEDULE) || '[]');
                schedule.forEach(dose => dose.taken = false);
                localStorage.setItem(STORAGE_KEYS.SCHEDULE, JSON.stringify(schedule));
            }
        }

        function loadAllData() {
            const savedSchedule = localStorage.getItem(STORAGE_KEYS.SCHEDULE);
            if (savedSchedule) {
                todaySchedule = JSON.parse(savedSchedule);
            } else {
                todaySchedule = [
                    { time: '08:00', taken: false, dose: '1 tab' },
                    { time: '11:00', taken: false, dose: '1 tab' },
                    { time: '14:00', taken: false, dose: '1 tab' },
                    { time: '17:00', taken: false, dose: '1 tab' },
                    { time: '20:00', taken: false, dose: '1 tab' }
                ];
                saveScheduleToStorage();
            }

            const siteCheckData = JSON.parse(localStorage.getItem(STORAGE_KEYS.SITE_CHECK) || '{}');
            siteCheckedToday = siteCheckData.checked || false;
            if (siteCheckedToday && siteCheckData.site) {
                updateSiteCheckButton(siteCheckData.site);
            }
        }

        function saveScheduleToStorage() {
            localStorage.setItem(STORAGE_KEYS.SCHEDULE, JSON.stringify(todaySchedule));
        }

        function saveRecord(type, data) {
            const records = JSON.parse(localStorage.getItem(STORAGE_KEYS.RECORDS) || '[]');
            const record = {
                id: Date.now(),
                date: new Date().toDateString(),
                time: new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'}),
                type: type,
                data: data
            };
            records.push(record);
            localStorage.setItem(STORAGE_KEYS.RECORDS, JSON.stringify(records));
            return record;
        }

        function getTodayRecords() {
            const records = JSON.parse(localStorage.getItem(STORAGE_KEYS.RECORDS) || '[]');
            const today = new Date().toDateString();
            return records.filter(r => r.date === today).reverse();
        }

        function updateDate() {
            const today = new Date();
            const options = { year: 'numeric', month: 'short', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = today.toLocaleDateString('en-US', options);
        }

        function switchMode(mode) {
            currentMode = mode;
            const oralBtn = document.getElementById('btn-oral');
            const pumpBtn = document.getElementById('btn-pump');
            const oralMode = document.getElementById('oralMode');
            const pumpMode = document.getElementById('pumpMode');

            if (mode === 'oral') {
                oralBtn.className = "px-3 py-1.5 rounded-full text-xs font-bold bg-blue-600 text-white shadow-md transition-all";
                pumpBtn.className = "px-3 py-1.5 rounded-full text-xs font-bold bg-gray-200 text-gray-600 shadow-sm transition-all";
                oralMode.classList.remove('hidden');
                pumpMode.classList.add('hidden');
            } else {
                pumpBtn.className = "px-3 py-1.5 rounded-full text-xs font-bold bg-blue-600 text-white shadow-md transition-all";
                oralBtn.className = "px-3 py-1.5 rounded-full text-xs font-bold bg-gray-200 text-gray-600 shadow-sm transition-all";
                pumpMode.classList.remove('hidden');
                oralMode.classList.add('hidden');
                updatePumpDisplay();
            }
        }

        // Oral Madopar functions
        function renderDoseList() {
            const container = document.getElementById('doseList');
            container.innerHTML = '';
            
            todaySchedule.forEach((dose, index) => {
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-3 rounded-xl border-2 ${dose.taken ? 'bg-green-50 border-green-300' : 'bg-white border-gray-200'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 ${dose.taken ? 'bg-green-500' : 'bg-blue-100'} rounded-full flex items-center justify-center">
                            <span class="text-lg">${dose.taken ? '' : ''}</span>
                        </div>
                        <div>
                            <div class="text-lg font-bold ${dose.taken ? 'text-gray-500 line-through' : 'text-gray-800'}">${dose.time}</div>
                            <div class="text-xs text-gray-500">Madopar ${dose.dose}</div>
                        </div>
                    </div>
                    ${!dose.taken ? `
                        <button onclick="takeDose(${index})" class="bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm btn-press shadow-md">
                            Take
                        </button>
                    ` : '<span class="text-green-600 font-bold text-sm">Done</span>'}
                `;
                container.appendChild(div);
            });
        }

        function checkNextDose() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            let nextDose = null;
            for (let dose of todaySchedule) {
                if (!dose.taken) {
                    const [h, m] = dose.time.split(':').map(Number);
                    const doseTime = h * 60 + m;
                    if (doseTime > currentTime) {
                        nextDose = dose;
                        break;
                    }
                }
            }
            
            const reminder = document.getElementById('nextDoseReminder');
            if (nextDose) {
                reminder.classList.remove('hidden');
                document.getElementById('nextDoseTimeDisplay').textContent = nextDose.time;
            } else {
                reminder.classList.add('hidden');
            }
        }

        function takeDose(index) {
            const dose = todaySchedule[index];
            dose.taken = true;
            lastDoseInfo = { time: dose.time, dose: dose.dose, index: index };
            
            saveScheduleToStorage();
            renderDoseList();
            checkNextDose();
            openSymptomModal();
        }

        function takeMedicineNow() {
            const index = todaySchedule.findIndex(d => !d.taken);
            if (index !== -1) {
                takeDose(index);
            }
        }

        function openSymptomModal() {
            currentSymptoms.clear();
            currentResponse = null;
            document.querySelectorAll('.symptom-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('.response-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-blue-400');
                btn.style.transform = '';
            });
            
            document.getElementById('symptomDoseInfo').textContent = `After ${lastDoseInfo.time} Madopar ${lastDoseInfo.dose}`;
            document.getElementById('symptomModal').classList.remove('hidden');
        }

        function toggleSymptom(btn, symptom) {
            if (currentSymptoms.has(symptom)) {
                currentSymptoms.delete(symptom);
                btn.classList.remove('selected');
            } else {
                currentSymptoms.add(symptom);
                btn.classList.add('selected');
            }
        }

        function selectResponse(btn, response) {
            document.querySelectorAll('.response-btn').forEach(b => {
                b.classList.remove('ring-4', 'ring-blue-400');
                b.style.transform = '';
            });
            btn.classList.add('ring-4', 'ring-blue-400');
            btn.style.transform = 'scale(1.05)';
            currentResponse = response;
        }

        function submitSymptomsAfterDose() {
            if (!currentResponse) {
                alert('Please select medication response (Good ON / Partial / Still OFF)');
                return;
            }
            
            const symptomNames = {
                'tremor': 'Tremor',
                'stiff': 'Stiffness',
                'slow': 'Slowness',
                'balance': 'Balance',
                'pain': 'Pain',
                'sleepy': 'Sleepy',
                'nausea': 'Nausea',
                'dyskinesia_mild': 'Mild Dyskinesia',
                'dyskinesia_severe': 'Severe Dyskinesia'
            };
            
            const responseNames = {
                'good': 'Good ON',
                'partial': 'Partial',
                'poor': 'Still OFF'
            };
            
            const symptomList = Array.from(currentSymptoms).map(s => symptomNames[s]).join(', ');
            
            saveRecord('medication', {
                time: lastDoseInfo.time,
                dose: lastDoseInfo.dose,
                response: currentResponse,
                symptoms: Array.from(currentSymptoms),
                symptomText: symptomList || 'No symptoms'
            });
            
            closeModal('symptomModal');
            showToast('Record Saved', `Response: ${responseNames[currentResponse]}`);
            renderAllRecords();
        }

        function editTodaySchedule() {
            const editor = document.getElementById('scheduleEditor');
            editor.innerHTML = '';
            
            todaySchedule.forEach((dose, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 bg-gray-50 p-2 rounded-lg';
                div.innerHTML = `
                    <input type="time" value="${dose.time}" class="flex-1 p-2 text-lg border-2 border-gray-300 rounded-lg" onchange="updateTime(${index}, this.value)">
                    <select class="p-2 border-2 border-gray-300 rounded-lg text-sm" onchange="updateDose(${index}, this.value)">
                        <option value="0.5 tab" ${dose.dose === '0.5 tab' ? 'selected' : ''}>0.5</option>
                        <option value="1 tab" ${dose.dose === '1 tab' ? 'selected' : ''}>1</option>
                        <option value="1.5 tab" ${dose.dose === '1.5 tab' ? 'selected' : ''}>1.5</option>
                        <option value="2 tab" ${dose.dose === '2 tab' ? 'selected' : ''}>2</option>
                    </select>
                    <button onclick="removeTimeSlot(${index})" class="text-red-500 p-2 font-bold text-xl">×</button>
                `;
                editor.appendChild(div);
            });
            
            document.getElementById('editScheduleModal').classList.remove('hidden');
        }

        function updateTime(index, value) {
            todaySchedule[index].time = value;
        }

        function updateDose(index, value) {
            todaySchedule[index].dose = value;
        }

        function removeTimeSlot(index) {
            todaySchedule.splice(index, 1);
            editTodaySchedule();
        }

        function addTimeSlot() {
            todaySchedule.push({ time: '12:00', taken: false, dose: '1 tab' });
            editTodaySchedule();
        }

        function saveSchedule() {
            saveScheduleToStorage();
            closeModal('editScheduleModal');
            renderDoseList();
            checkNextDose();
            showToast('Schedule Updated', 'Today\'s plan saved');
        }

        function addNewDose() {
            editTodaySchedule();
        }

        function recordOffEpisode(type) {
            const types = {
                'sudden': 'Sudden Freeze',
                'wearing': 'Wearing Off'
            };
            
            saveRecord('off_episode', { type: type, description: types[type] });
            showToast('Recorded', `${types[type]} - ${new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}`);
            renderAllRecords();
        }

        // Pump functions
        function updatePumpDisplay() {
            const pumpData = JSON.parse(localStorage.getItem(STORAGE_KEYS.PUMP_DATA) || '{}');
            
            if (!pumpData.baseRate) {
                // Default values
                pumpData.baseRate = 3.5;
                pumpData.cartridgeTotal = 100;
                pumpData.drugLeft = 65;
                pumpData.hoursRunning = 0;
                pumpData.todayTotal = 0;
                pumpData.bolusCount = 0;
                pumpData.bolusRecords = [];
                localStorage.setItem(STORAGE_KEYS.PUMP_DATA, JSON.stringify(pumpData));
            }
            
            document.getElementById('bolusCountToday').textContent = `Today: ${pumpData.bolusCount || 0}`;
            
            const bolusList = document.getElementById('bolusList');
            bolusList.innerHTML = '';
            const bolusRecords = pumpData.bolusRecords || [];
            bolusRecords.slice().reverse().forEach(bolus => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-orange-50 rounded-lg text-sm';
                div.innerHTML = `
                    <span class="font-medium text-gray-700">${bolus.time}</span>
                    <span class="text-orange-600 font-bold">${bolus.reason} ${bolus.note ? '('+bolus.note+')' : ''}</span>
                `;
                bolusList.appendChild(div);
            });
            
            const baseRate = pumpData.baseRate || 3.5;
            const hoursRunning = pumpData.hoursRunning || 0;
            const baseTotal = baseRate * hoursRunning;
            const bolusTotal = (pumpData.bolusCount || 0) * 4;
            const totalToday = baseTotal + bolusTotal;
            
            document.getElementById('pumpBaseRate').innerHTML = `${baseRate} <span class="text-sm">mg/h</span>`;
            document.getElementById('pumpTotalToday').innerHTML = `${Math.round(totalToday)} <span class="text-sm">mg</span>`;
            
            const drugLeft = pumpData.drugLeft || 0;
            const cartridgeTotal = pumpData.cartridgeTotal || 100;
            const percentLeft = Math.round((drugLeft / cartridgeTotal) * 100);
            
            document.getElementById('drugLeftPercent').textContent = `${percentLeft}%`;
            document.getElementById('drugLeftBar').style.width = `${percentLeft}%`;
            
            if (percentLeft < 20) {
                document.getElementById('refillNotice').textContent = ' URGENT: Refill pump now!';
                document.getElementById('refillNotice').className = 'text-xs text-red-600 font-bold mt-2';
            } else {
                const hoursLeft = drugLeft / baseRate;
                const refillTime = new Date(Date.now() + hoursLeft * 3600000);
                const timeStr = refillTime.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
                document.getElementById('refillNotice').textContent = `Estimated refill at ${timeStr}`;
                document.getElementById('refillNotice').className = 'text-xs text-orange-600 font-medium mt-2';
            }
        }

        function editPumpSettings() {
            const pumpData = JSON.parse(localStorage.getItem(STORAGE_KEYS.PUMP_DATA) || '{}');
            document.getElementById('settingBaseRate').value = pumpData.baseRate || 3.5;
            document.getElementById('settingCartridgeTotal').value = pumpData.cartridgeTotal || 100;
            document.getElementById('settingDrugLeft').value = pumpData.drugLeft || 65;
            document.getElementById('pumpSettingsModal').classList.remove('hidden');
        }

        function savePumpSettings() {
            const pumpData = JSON.parse(localStorage.getItem(STORAGE_KEYS.PUMP_DATA) || '{}');
            pumpData.baseRate = parseFloat(document.getElementById('settingBaseRate').value) || 3.5;
            pumpData.cartridgeTotal = parseFloat(document.getElementById('settingCartridgeTotal').value) || 100;
            pumpData.drugLeft = parseFloat(document.getElementById('settingDrugLeft').value) || 65;
            localStorage.setItem(STORAGE_KEYS.PUMP_DATA, JSON.stringify(pumpData));
            
            closeModal('pumpSettingsModal');
            updatePumpDisplay();
            showToast('Settings Saved', 'Pump configuration updated');
        }

        function recordBolus() {
            currentBolusReason = null;
            document.querySelectorAll('.bolus-reason-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-orange-400', 'scale-105');
            });
            document.getElementById('bolusNote').value = '';
            document.getElementById('bolusModal').classList.remove('hidden');
        }

        function selectBolusReason(btn, reason) {
            document.querySelectorAll('.bolus-reason-btn').forEach(b => {
                b.classList.remove('ring-4', 'ring-orange-400');
                b.style.transform = '';
            });
            btn.classList.add('ring-4', 'ring-orange-400');
            btn.style.transform = 'scale(1.05)';
            currentBolusReason = reason;
        }

        function submitBolus() {
            if (!currentBolusReason) {
                alert('Please select a reason');
                return;
            }
            
            const reasons = {
                'sudden': 'Sudden OFF',
                'wearing': 'Wearing Off',
                'morning': 'Morning Stiff',
                'stress': 'Stress'
            };
            
            const time = new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
            const note = document.getElementById('bolusNote').value;
            
            const pumpData = JSON.parse(localStorage.getItem(STORAGE_KEYS.PUMP_DATA) || '{}');
            pumpData.bolusCount = (pumpData.bolusCount || 0) + 1;
            pumpData.bolusRecords = pumpData.bolusRecords || [];
            pumpData.bolusRecords.push({
                time: time,
                reason: reasons[currentBolusReason],
                note: note,
                amount: '3-5mg'
            });
            pumpData.drugLeft = (pumpData.drugLeft || 65) - 4; // Subtract average bolus dose
            localStorage.setItem(STORAGE_KEYS.PUMP_DATA, JSON.stringify(pumpData));
            
            saveRecord('bolus', {
                reason: currentBolusReason,
                description: reasons[currentBolusReason],
                note: note
            });
            
            closeModal('bolusModal');
            showToast('Bolus Recorded', `${reasons[currentBolusReason]} - ${time}`);
            updatePumpDisplay();
            renderAllRecords();
        }

        function doDailySiteCheck() {
            if (siteCheckedToday) {
                showToast('Already Checked', 'Only once per day needed');
                return;
            }
            selectedSite = null;
            selectedSkinStatus = null;
            document.querySelectorAll('.site-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.skin-btn').forEach(btn => {
                btn.classList.remove('ring-4', 'ring-blue-400');
                btn.style.transform = '';
            });
            document.getElementById('siteCheckModal').classList.remove('hidden');
        }

        function selectSite(btn, site) {
            document.querySelectorAll('.site-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedSite = site;
        }

        function selectSkinStatus(btn, status) {
            document.querySelectorAll('.skin-btn').forEach(b => {
                b.classList.remove('ring-4', 'ring-blue-400');
                b.style.transform = '';
            });
            btn.classList.add('ring-4', 'ring-blue-400');
            btn.style.transform = 'scale(1.05)';
            selectedSkinStatus = status;
        }

        function submitSiteCheck() {
            if (!selectedSite) {
                alert('Please select infusion site');
                return;
            }
            if (!selectedSkinStatus) {
                alert('Please select skin condition');
                return;
            }
            
            siteCheckedToday = true;
            
            const siteCheckData = {
                checked: true,
                site: selectedSite,
                skinStatus: selectedSkinStatus,
                date: new Date().toDateString(),
                time: new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})
            };
            localStorage.setItem(STORAGE_KEYS.SITE_CHECK, JSON.stringify(siteCheckData));
            
            updateSiteCheckButton(selectedSite);
            
            const skinStatusText = selectedSkinStatus === 'good' ? 'Good' : selectedSkinStatus === 'red' ? 'Red' : 'Nodule';
            
            saveRecord('site_check', {
                site: selectedSite,
                siteName: siteNames[selectedSite],
                skinStatus: selectedSkinStatus,
                skinStatusText: skinStatusText
            });
            
            closeModal('siteCheckModal');
            showToast('Check Completed', `${siteNames[selectedSite]} - ${skinStatusText}`);
            renderAllRecords();
        }

        function updateSiteCheckButton(site) {
            document.getElementById('siteCheckStatus').textContent = 'Completed';
            document.getElementById('siteCheckStatus').className = 'text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full font-bold';
            document.getElementById('siteCheckBtn').className = 'w-full bg-green-500 text-white font-bold text-lg py-3 rounded-xl btn-press flex items-center justify-center gap-2 mb-3 cursor-default';
            document.getElementById('siteCheckBtn').innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Today\'s Check Done';
            document.getElementById('siteCheckBtn').onclick = null;
            
            document.getElementById('currentSiteDisplay').classList.remove('hidden');
            document.getElementById('currentSiteText').textContent = siteNames[site];
        }

        // Data management
        function exportData() {
            const data = {
                exportDate: new Date().toISOString(),
                schedule: JSON.parse(localStorage.getItem(STORAGE_KEYS.SCHEDULE) || '[]'),
                records: JSON.parse(localStorage.getItem(STORAGE_KEYS.RECORDS) || '[]'),
                pumpData: JSON.parse(localStorage.getItem(STORAGE_KEYS.PUMP_DATA) || '{}'),
                siteCheck: JSON.parse(localStorage.getItem(STORAGE_KEYS.SITE_CHECK) || '{}')
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.getElementById('downloadLink');
            link.href = url;
            link.download = `PD-Helper-Backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showToast('Data Exported', 'File saved to Downloads folder');
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (confirm('This will replace all current data. Continue?')) {
                            if (data.schedule) localStorage.setItem(STORAGE_KEYS.SCHEDULE, JSON.stringify(data.schedule));
                            if (data.records) localStorage.setItem(STORAGE_KEYS.RECORDS, JSON.stringify(data.records));
                            if (data.pumpData) localStorage.setItem(STORAGE_KEYS.PUMP_DATA, JSON.stringify(data.pumpData));
                            if (data.siteCheck) localStorage.setItem(STORAGE_KEYS.SITE_CHECK, JSON.stringify(data.siteCheck));
                            
                            location.reload();
                        }
                    } catch (err) {
                        alert('Invalid file format');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function renderAllRecords() {
            const container = document.getElementById('todayRecords');
            container.innerHTML = '';
            
            const records = getTodayRecords();
            
            if (records.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">No records yet today</div>';
                return;
            }
            
            records.forEach(record => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm fade-in';
                
                let emoji = '';
                let text = '';
                
                switch(record.type) {
                    case 'medication':
                        const responseEmoji = record.data.response === 'good' ? '' : record.data.response === 'partial' ? '' : '';
                        const dyskinesia = record.data.symptoms.find(s => s.includes('dyskinesia'));
                        emoji = dyskinesia ? '' : responseEmoji;
                        text = `${record.time} Madopar - ${record.data.symptomText || 'No symptoms'}`;
                        break;
                    case 'off_episode':
                        emoji = record.data.type === 'sudden' ? '' : '';
                        text = `OFF: ${record.data.description}`;
                        break;
                    case 'bolus':
                        emoji = '';
                        text = `Bolus: ${record.data.description}`;
                        break;
                    case 'site_check':
                        emoji = '';
                        text = `Site: ${record.data.siteName} ${record.data.skinStatusText}`;
                        break;
                    default:
                        text = 'Unknown record';
                }
                
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                        <span class="text-gray-700">${text}</span>
                    </div>
                    <span class="text-lg">${emoji}</span>
                `;
                container.appendChild(div);
            });
        }

        function clearAllData() {
            if (confirm('WARNING: This will delete ALL saved data including schedules and records.\n\nAre you sure?')) {
                Object.values(STORAGE_KEYS).forEach(key => localStorage.removeItem(key));
                location.reload();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showToast(title, message) {
            document.getElementById('toastTitle').textContent = title;
            document.getElementById('toastMessage').textContent = message;
            const toast = document.getElementById('successToast');
            toast.classList.remove('-translate-y-full');
            setTimeout(() => {
                toast.classList.add('-translate-y-full');
            }, 2500);
        }

        function emergencyCall() {
            if (confirm('Call emergency contact?\n\nYou can also dial 911 directly\n\nContinue?')) {
                window.location.href = 'tel:911';
            }
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('fixed')) {
                event.target.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
